/* History:© 2001 John Henry Thompson. All rights reserved2001.05.22	jht	Split off.*/#include "CCapturePane.h"// ---------------------------------------------------------------------------------/* Show color diff, max color clamp */void	CCapturePane::ComputeMotionPaint(){	int					hcount;	int					vcount;	int					width;	int					height;	int					rowBytes;		UInt32*				sourcePtr; 	UInt32*				monitorPtr; 	UInt32*				previous2Ptr; 	UInt32*				brushPtr; 	UInt32*				compositePtr; 		UInt32*				sourceLinePtr; 	UInt32*				monitorLinePtr; 	UInt32*				previous2LinePtr; 	UInt32*				brushLinePtr; 	UInt32*				compositeLinePtr; 		int	capPix;	int diffwPix;	#if 0	int	tolerance = diffTolerance*3;	#else	int	tolerance = diffTolerance*diffTolerance;	#endif		sourcePtr = (UInt32*)GetPixBaseAddr( GetGWorldPixMap(gwSourcePtr) );		monitorPtr = (UInt32*)GetPixBaseAddr( GetGWorldPixMap(gwMonitorPtr) );		previous2Ptr = (UInt32*)GetPixBaseAddr( GetGWorldPixMap(gwPrevious2Ptr) );	brushPtr = (UInt32*)GetPixBaseAddr( GetGWorldPixMap(gwBrushPtr) );	compositePtr = (UInt32*)GetPixBaseAddr( GetGWorldPixMap(gwCompositePtr) );	/* Assume all gworlds have the same rowBytes */		rowBytes = (**GetGWorldPixMap(gwCompositePtr)).rowBytes & 0x3FFF;	rowBytes = rowBytes / 4;		width = captureRect.right - captureRect.left;	height = captureRect.bottom - captureRect.top;	for (vcount = height; 		vcount > 0; 		vcount--, 			sourcePtr += rowBytes, 			monitorPtr += rowBytes,			previous2Ptr += rowBytes,			brushPtr += rowBytes,			compositePtr += rowBytes)	{		sourceLinePtr = sourcePtr ;		previous2LinePtr = previous2Ptr ;		monitorLinePtr = monitorPtr;		brushLinePtr = brushPtr;		compositeLinePtr = compositePtr;				for (hcount = width; 				hcount > 0; 				hcount--, 			sourceLinePtr++,  			previous2LinePtr++,			monitorLinePtr++, 			brushLinePtr++,			compositeLinePtr++)		{			#if 0			capPix = ((UInt8*)sourceLinePtr)[1] + ((UInt8*)sourceLinePtr)[2] + ((UInt8*)sourceLinePtr)[3];   			diffwPix = ((UInt8*)previous2LinePtr)[1] + ((UInt8*)previous2LinePtr)[2] + ((UInt8*)previous2LinePtr)[3] - capPix; 			if (diffwPix < -tolerance || diffwPix > tolerance) 			#else 			/* Compute distance between pixels */			capPix = ((UInt8*)sourceLinePtr)[1] - ((UInt8*)previous2LinePtr)[1];			diffwPix = capPix*capPix;			capPix   = ((UInt8*)sourceLinePtr)[2] - ((UInt8*)previous2LinePtr)[2];			diffwPix += capPix*capPix;			capPix   = ((UInt8*)sourceLinePtr)[3] - ((UInt8*)previous2LinePtr)[3];			diffwPix += capPix*capPix;			if (diffwPix > tolerance)			#endif			{ 				/* There is  difference  */ 				#if 0				// show image				*monitorLinePtr = *sourceLinePtr;				#endif				#if 0				// show white				*monitorLinePtr = -1;				#endif				#if 1				// show gray				capPix = ( ((UInt8*)sourceLinePtr)[1] + ((UInt8*)sourceLinePtr)[2] + ((UInt8*)sourceLinePtr)[3] ) /3;				capPix = 128 + capPix/2;				((UInt8*)monitorLinePtr)[1] = capPix;				((UInt8*)monitorLinePtr)[2] = capPix;				((UInt8*)monitorLinePtr)[3] = capPix;				#endif								#if 0				// Paint white for testing				*compositeLinePtr = -1;					#endif				#if 1				// composite brush				*compositeLinePtr = *brushLinePtr;				#endif			} 			else 			{ 				/* No difference */ 				*monitorLinePtr = *compositeLinePtr;			} 		}	}		{		const BitMap	*pSource; 		const BitMap	*pDest;		GrafPtr	myPort = GetMacPort();		pSource = GetPortBitMapForCopyBits( gwMonitorPtr );		pDest = GetPortBitMapForCopyBits( myPort );		CopyBits( pSource, pDest, &captureRect, &drawRect, inkMode, 0);	}}