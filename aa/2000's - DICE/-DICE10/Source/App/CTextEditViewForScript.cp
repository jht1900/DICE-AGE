/* Special processing for script text edit pane.History:Copyright © 2003 John Henry Thompson. All rights reserved.2003.03.21	jht	Created.*/#include "CTextEditViewForScript.h"#include "dicejs.h"#include "dicejs_fio.h"#include <stdlib.h>#include <string.h>// ---------------------------------------------------------------------------------CTextEditViewForScript::CTextEditViewForScript(){	dicejs_setTextEditView( this );}// ---------------------------------------------------------------------------------CTextEditViewForScript::CTextEditViewForScript(	LStream	*inStream )		: LTextEditView( inStream ){}// ---------------------------------------------------------------------------------voidCTextEditViewForScript::FinishCreateSelf(){	dicejs_setTextEditView( this );}// ---------------------------------------------------------------------------------CTextEditViewForScript::~CTextEditViewForScript(){}// ---------------------------------------------------------------------------------Boolean		CTextEditViewForScript::HandleKeyPress(const EventRecord	&inKeyEvent){	Boolean	result;	SInt16		theKey		 = (SInt16) (inKeyEvent.message & charCodeMask);	result = LTextEditView::HandleKeyPress( inKeyEvent );		if (theKey == char_Return)	{		// Pick up line of script preceding return character		char	*buf = 0;		int		len = 0;		TEHandle	teh = 0;		Handle		hdl = 0;		char	*str;		int		eolPos;		int		pos;				teh = this->GetMacTEH();		hdl = this->GetTextHandle();				str = *hdl;		eolPos = (**teh).selStart - 2;		pos = eolPos;		for (; pos > 0 ; pos--)		{			if (str[pos] == '\r')			{				pos++;				break;			}		}		len = eolPos - pos + 1; // Does not include EOL 0x0D				buf = (char *)malloc( len );		if (! buf)			goto exit;					memcpy( buf, *hdl + pos, len );		//dicejs_setTextEditView( this );				dicejs_EvalStringPrint( buf, len );				free( buf );	}	exit:;	return result;}								// ---------------------------------------------------------------------------------// ---------------------------------------------------------------------------------