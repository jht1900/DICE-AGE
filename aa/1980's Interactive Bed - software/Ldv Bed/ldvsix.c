/* pioneer.cControl that Pioneer LD-V6000 player.4/15/87 JT.10/9/87 JT. updated for z.*/#include <SerialDvr.h>#include "pioneer.h"#include "qDef.h"#include "vdisc.h"static int chan = AoutRefNum;#define PPort sPortA#define NOVAL	((unsigned int) 0xFACE)/* -------------------- vdreadpos -------------------------------------- */static vdreadpos()	{	unsigned int	it = NOVAL;	long			to = TickCount() + 5*60;		vdread();	Vd1(GimmeFrame);		for (;;)		{		if (Button()) return (it);		if ((it = vdread()) != NOVAL)			return (it);		if (TickCount() > to)			{			doalert("\pLD-V6000 is not responding",				"\pPlease check serial cable or power",				"\pAlso make sure deck is in play",				"\p");			return (NOVAL);			}		}	}/* ------------------ vdread ------------------------------------------- */static int vdread()	{	long count;	Byte buf[32];	int	er;	int n;		SerGetBuf(chan + 1, &count);	if (count >= 6)		{		er = FSRead(chan + 1, &count, buf);		if (er) OhShit("\pFSRead er=%d on count=%d\n", er, count);				buf[count] = 0;		stch_i(buf, &n);		#if 0		printf("buf=%s n=%u\n",buf,n);#endif		return ( n );		}			return (NOVAL);	}/* -------------------------- vdwaitfor --------------------------- */static vdwaitfor(target)	unsigned int		target;	{	unsigned int		vl;	long	tt;	#if 0	printf("waiting for %u\n", target);#endif	for (; !Button();)		{#if 0		Delay(3L, &tt);#endif		vl = vdreadpos();		if (vl == target)			return (vl);		}	}	/* ---------------------- Vd1 ------------------------------------*/	static Vd1(what)	int what;	{	long tt;	Delay(3L, &tt);	VdSendByte(what);	VdSendEOL();	}	static Vd(what, arg)	int	what;	int	arg;	{	VdSendNum(arg);	VdSendByte(what);	VdSendEOL();	}	static Byte digMap[10] = { 0x3F, 0x0F, 0x8F, 0x4F, 0x2F, 							0xAF, 0x6F, 0x1F, 0x9F, 0x5F };static VdSendNum(arg)	int	arg;	{	Byte buf[16];	int i;	sprintf(buf, "%u", arg);		for (i = 0; ; i++)		{		if (! buf[i]) return;		VdSendByte(digMap[buf[i] - '0']);		}	}	static Byte hexMap[16] = { '0', '1', '2', '3', '4', 							'5', '6' , '7', '8', '9', 							'A', 'B', 'C', 'D', 'E', 'F' };	static VdSendByte(n)	{	VdSendRaw(hexMap[(n>>4) & 0x0f]);	VdSendRaw(hexMap[n & 0x0f]);	}	static VdSendEOL()	{	VdSendRaw(0x0D);	VdSendRaw(0x0A);	}	static VdSendRaw(n)	Byte	n;	{	long count = 1;	int er;	er = FSWrite(chan, &count, &n);	if (er) OhShit("VdSendRaw: er=%d\n", er);	}	/* ------------------------- init ------------------------------------ */static init()	{	int serConfig = baud9600 + stop10 + noParity + data8;	int er;	SerShk	sh;		sh.fXOn = 0;	sh.fCTS = 1;	sh.evts = 0;	sh.fInX = 0;	sh.fDTR = 0;	er = RAMSDOpen(PPort);	if (er) OhShit("Er=%d on RAMSopen\n", er);	er = SerReset(chan, serConfig);	if (er) OhShit("er=%d on serreset of output\n", er);	er = SerReset(chan + 1, serConfig);	if (er) OhShit("er=%d on serreset of input\n", er);	er = SerHShake(chan, &sh);	if (er) OhShit(" serhshake out");		er = SerHShake(chan+1, &sh);	if (er) OhShit(" serhshake in");		}	static play()	{	Vd1(Play);	}	static stop()	{	Vd1(Stop);	}	static unsigned int searchpos;	static search(a)	{	searchpos = a;	Vd(Search, a);	}	static searchwait()	{	vdwaitfor(searchpos);	}	static pos()	{	return (vdreadpos());	}	static stepfwd()	{	Vd1(StepFwd);	}	static steprev()	{	Vd1(StepRev);	}	static ff(n)	{	Vd(FastSpeed, n);	Vd(SearchFwd, 0xFFFF);	}	static rew(n)	{	Vd(FastSpeed, n);	Vd(SearchRev, 0x0000);	}	static slowfwd(n)	{	Vd(SlowSpeed, n);	Vd(SearchFwd, 0xFFFF);	}	static slowrev(n)	{	Vd(SlowSpeed, n);	Vd(SearchRev, 0x0000);	}	static video(n)	{	Vd1(n? SetVideoOn: SetVideoOff);	}	static audio(n)	{	Vd(SetAudio, n);	}	static frame(n)	{	Vd(DisplayFrame, n);	}	static chargen(n)	{	Vd1(n? CharGenOn: CharGenOff);	}	static setmark(n)	{	}	static stopat(n)	{	Vd(AutoStop, n );	}	static audiosq(n)	{	}		static text(linen, coln, str)	int		linen;	int		coln;	Byte	*str;	{	}	static cleartext()	{	}static int (*msgTable[])() =	{	init,	play, stop, search, searchwait, pos,	stepfwd, steprev, ff, rew, slowfwd, slowrev,	video, audio,	frame, chargen,	setmark, stopat,	audiosq, text, cleartext	};Object ldvsixObj = msgTable;/* --------------------------------------------------------------------- */