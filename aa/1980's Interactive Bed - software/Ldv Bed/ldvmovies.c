/*10/5/87 The interactive movies.*/#include "qDef.h"#include "vdisc.h"#define MaxSameCount	5int		audon = 3;static int 			on;static unsigned int	outPos;/* -------------------- movSound --------------------------------------*/movSound(sndList, func)	qList	*sndList;	int		(*func)();	{	unsigned int	soundOut;	unsigned int	soundIn;	unsigned int	pos;	int				soundOn;	qList			*sp;	int				v = -2, ov;	int				first = 1;	int				sameCount = 0;		on = -2;		if (!Listp(sndList))		soundOn = 0;	else		{		soundOn = 1;		soundOut = 0;		SelPort(AUD);		z(STOP,0);		SelPort(VID);		}		for (; !Button();)		{		ov = v;		v = (*func)();		if (ov == v && ov >= 0)			{			if (++sameCount >= MaxSameCount)				{				zzz(TEXT,8,0," ");				sameCount = 0;				}			}		else			sameCount = 0;					if (v < 0) 			{			if (first && v == -1) continue;			if (soundOn)				{				SelPort(AUD);				z(STOP,0);				SelPort(VID);				}			return (v);			}		first = 0;		if (! soundOn) continue;		SelPort(AUD);		pos = z(POS,0);		if (pos >= soundOut)			{			if (!Listp(sndList))				{				z(STOP,0);				SelPort(VID);				z(VIDEO,0);				z(AUDIO,0);				z(STOP,0);				return (-3);				}			sp = (qList *)Car(sndList);			sndList = Cdr(sndList);			if (!Listp(sp))				{				soundIn = (unsigned int)sp;				if (!Listp(sndList))					soundOut = 0xFFFF;				else					{					soundOut = Car(sndList);					sndList = Cdr(sndList);					}				}			else {				soundIn = Car(sp);				sp = Cdr(sp);				if (!Listp(sp))					soundOut = 0xFFFF;				else					soundOut = Car(sp);				}			if (soundIn > 0 && soundIn < 54001)				{								z(SEARCH, soundIn);				z(SEARCHWAIT,0);				z(PLAY,0);				}			else SysBeep(1);			}		SelPort(VID);		}	SelPort(AUD);	z(STOP,0);	SelPort(VID);	z(VIDEO,0);	z(AUDIO,0);	ThrowToTop();	}	/* -------------------- mov1 -------------------------------------------*//* VTR 1 */static mov1(sndList)	qList	*sndList;	{	int	_mov1();		on = -2;	zzz(TEXT, 8, 0, "] ] - - o o - - ] ] ");	return (movSound(sndList, &_mov1));	}static _mov1()	{	int		n, c;	Byte	*cp;		n = GetLoc();	if (n != on)		{		if (on < 0) 			{			z(VIDEO,1);			}		on = n;		if (n < 0) 			{			z(VIDEO,0);			z(AUDIO,0);			z(STOP,0);			return (n);			}		c = 2*n;		n = n>>1;		switch (n)			{			case 5:			case 4:				z(PLAY,0);				z(AUDIO,audon);				cp = "]";				break;			case 3:				z(SLOWFWD,3);				z(AUDIO,audon);				cp = "-";				break;			case 2:				z(STOP,0);				z(AUDIO,0);				cp = "O";				break;			case 1:				z(SLOWFWD,3);				z(AUDIO,audon);				cp = "-";				break;			case 0:				z(PLAY,0);				z(AUDIO,audon);				cp = "]";				break;			default:				cp = "!";				break;							}		if (c > 19) c = 19;		zzz(TEXT, 8, 19 - c, cp);		}	return (n);	}/* -------------------- mov1a -------------------------------------------*//* VTR 2 */static mov1a(sndList)	qList	*sndList;	{	int	_mov1a();		on = -2;	zzz(TEXT, 8, 0, "]] ] - - o o - - ] ]");	return (movSound(sndList, &_mov1a));	}static _mov1a()	{	int		n, c;	Byte	*cp;		n = GetLoc();	if (n != on)		{		if (on < 0) 			{			z(VIDEO,1);			}		on = n;		if (n < 0) 			{ 			z(VIDEO,0);			z(AUDIO,0);			z(STOP,0);			return (n); 			}		c = 2*n;		n = (n+1)>>1;		switch (n)			{			case 5:				z(AUDIO,0);				z(FF, 2);				cp = "]]";				break;			case 4:				z(PLAY,0);				z(AUDIO,audon);				cp = "]";				break;			case 3:				z(SLOWFWD,3);				z(AUDIO,audon);				cp = "-";				break;			case 2:				z(AUDIO,0);				z(STOP,0);				cp = "O";				break;			case 1:				z(SLOWFWD,3);				z(AUDIO,audon);				cp = "-";				break;			case 0:				z(PLAY,0);				z(AUDIO,audon);				cp = "]";				break;			default:				cp = "!";				break;			}		if (c > 19) c = 19;		zzz( TEXT, 8, 19 - c, cp);		}	return (n);	}/* -------------------- mov2 -------------------------------------------*//* Action Jackson bed */static int beatPeriod;static int vidOn;static mov2(sndList, nbeat)	qList	*sndList;	qItem	nbeat;	{	int	_mov2();		beatPeriod = Cnum(nbeat);	outPos = 0xFFFF;		zzz(TEXT, 8, 0, " ");	return (movSound(sndList, &_mov2));	}static _mov2(nbeat)	{	int		n, c;	Byte	*cp;	unsigned int	pos;		pos = z(POS,0);	if (pos >= outPos)		{		z(AUDIO,0);		z(STOP,0);		}		n = GetLoc();		if (n/2 != on/2)		{		if (on < 0) 			{			z(PLAY,0);			z(VIDEO,1);			z(AUDIO,audon);			}		on = n;		if (n < 0) 			{ 			z(VIDEO,0);			z(AUDIO,0);			z(STOP,0);			return (n); 			}		z(PLAY,0);		z(AUDIO,audon);		outPos = pos + beatPeriod;		}	return (n);	}	/* -------------------- mov2a -------------------------------------------*/static mov2a(sndList)	qList	*sndList;	{	int	_mov2a();		vidOn = 1;			zzz(TEXT, 8, 0, " ");	return (movSound(sndList, &_mov2a));	}	static _mov2a()	{	int		n, c;	Byte	*cp;		n = GetLoc();	if (n/2 != on/2)		{		if (on < 0) 			{			z(PLAY,0);			z(VIDEO,1);			z(AUDIO,audon);			}		on = n;		if (n < 0) 			{ 			z(VIDEO,0);			z(AUDIO,0);			z(STOP,0);			outPos = 0xFFFF;				return (n); 			}		z(VIDEO,vidOn);		vidOn ^= 1;		}	return (n);	}/* -------------------- mov2b -------------------------------------------*/static mov2b(sndList)	qList	*sndList;	{	int	_mov2b();		vidOn = 1;			zzz(TEXT, 8, 0, " ");	return (movSound(sndList, &_mov2b));	}	static _mov2b()	{	int		n, c;	Byte	*cp;		n = GetLoc();	if (n/2 != on/2)		{		if (on < 0) 			{			z(PLAY,0);			z(VIDEO,1);			z(AUDIO,audon);			}		on = n;		if (n < 0) 			{ 			z(VIDEO,0);			z(AUDIO,0);			z(STOP,0);			return (n); 			}		if (vidOn) 			{			z(AUDIO,audon);			z(PLAY,0);			}		else 			{			z(AUDIO,0);			z(STOP,0);			}		vidOn ^= 1;		}	return (n);	}	/* -------------------- mov3 -------------------------------------------*/#define nmov	4static Byte *markers[] = { "+", "++", "II", "I" };static qItem	*movList;static qList	*movp[4];static int		movIndex, omovIndex, movSpeed;static mov3(sndList, speed, f1, f2, f3, f4)	qList	*sndList;	qItem	speed;	qItem	f1;	qItem	f2;	qItem	f3;	qItem	f4;	{	int		i;	int		_mov3();		movList = &f1;		for (i = 0; i < nmov; i++)		{		movp[i] = (qList *)movList[i];		}			movSpeed = Cnum(speed);	movIndex = 0;	omovIndex = -1;		outPos = 0xFFFF;		zzz(TEXT, 8, 0, "I I II  ++  + + ");			return ( movSound(sndList, &_mov3) );	}	static _mov3()	{	qList	*ll;	unsigned int	pos;	int		dosearch, c, n;			if (Button()) return (-4);	n = GetLoc();		dosearch = 0;		if (n != on)		{		if (on < 0) 			{			z(VIDEO,1);			}		on = n;		if (n < 0) 			{ 			z(VIDEO,0);			z(AUDIO,0);			z(STOP,0);			return (n); 			}		c = n<<1;		if (c > 18) c = 18;		n = (n+1)/3;		if (n > 3) n = 3;		zzz(TEXT, 8, 18 - c, markers[n]);		movIndex = n;		dosearch = (movIndex != omovIndex);		omovIndex = movIndex;		}	pos = z(POS,0);	if (pos >= outPos || dosearch)		{		/* Play next clip in list. checking for wrap around.		*/		ll = movp[movIndex];		if (! Listp(ll))			{			ll = (qList *)movList[movIndex];			}		if (! Listp(ll)) 			{ 			printf("Null movie list\n");			return(n);			}		movp[movIndex] = Cdr(ll);		ll = (qList *) Car(ll);		if (! Listp(ll))			{			printf("Not movie list %lx\n", ll);			return (n);			}		if (Listp(Cdr(ll)))			{			z(AUDIO,0);			z(SEARCH, (unsigned int) Car(ll));			z(SEARCHWAIT, 0);						if (movSpeed == 1) z(PLAY,0);			else if (movSpeed < 0) z(SLOWFWD, -movSpeed);			else if (movSpeed > 0) z(FF, movSpeed);						if (movSpeed != 0) 				z(AUDIO,audon);						outPos = (unsigned int) Cadr(ll);			z(SETMARK, outPos);			outPos -= 3;			}		}	return (n);	}/* ---------------------------------------------------------------------- */qIfunc movieFuncs[] ={	{ mov1, "mov1", 1 + qRetInt },	{ mov1a, "mov1a", 1 + qRetInt },	{ mov2, "mov2", 2 + qRetInt },	{ mov2a, "mov2a", 1 + qRetInt },	{ mov2b, "mov2b", 1 + qRetInt },	{ mov3, "mov3", 6 + qRetInt },		{ 0, 0, 0 }};/* --------------------------------------------------------------------- */