/*Video Works Presser (aka Compiler)September 5, 1987.John Thompson.*/#include <WindowMgr.h>#include <MenuMgr.h>#include <EventMgr.h>#include <ToolboxUtil.h>#include <stdio.h>#include "VWPress.h"#include "VWPressMenu.h"#define TRACE(a,b) printf bMenuHandle		myMenus[NMENU];Cursor			waitCursor;VWPressState	me;WindowPtr		expwindow;extern int CurPageOption : 0x936;/* ---------- main ---------------------------------------------------- */main()	{	Initialize();		for (;;) 		{		MainEvent();		StepState();		}	}	/* ------------ Initialize -------------------------------------------- */	Initialize()	{	InitGraf(&thePort);	InitFonts();	FlushEvents(everyEvent, 0);	InitWindows();	InitMenus();	TEInit();	InitDialogs(0L);	MaxApplZone();		SetupGrowZone();	SetupCursors();	SetupMenus();		SetupVWWindow();	OvwOpenDriver();			InitState();		}	/* -------------- MainEvent -------------------------------------------- */int MainEvent()	{	EventRecord	myEvent;	MaintainCursor();	SystemTask();	if (GetNextEvent(everyEvent, &myEvent) == FALSE)		return;			if (me.showConsole)		StdEvent(&myEvent);			switch (myEvent.what) 		{		case mouseDown:			DoMouseDown(&myEvent);			break;		case keyDown:		case autoKey:			DoKeyDown(&myEvent);			break;		case activateEvt:			DoActiveate(&myEvent);			break;		case updateEvt:			DoUpdate(&myEvent);			break;		}		return;	}/* ------------ DoMouseDown ------------------------------------------- */Rect			dragRect = { 0, 0, 1024, 1024 };DoMouseDown(ev)	EventRecord	*ev;	{	WindowPtr		whichWindow;	switch (FindWindow(ev->where, &whichWindow))		{		case inGoAway:#if 0			if (ours(whichWindow))				{				TrackGoAway(ds->view->window, ev->where);				CloseView(ds->view);				}#endif			break;		case inMenuBar:			return( DoCommand( MenuSelect(ev->where) ));			break;		case inSysWindow:			SystemClick(ev, whichWindow);			break;		case inDrag:#if 0			if (ours(whichWindow))				{				DragWindow(whichWindow, ev->where, &dragRect);				SetPort(ds->view->window);				NewViewRect(ds->view);				}#endif			break;		case inGrow:#if 0			if (ours(whichWindow))				GrowView(ds, ev);			break;#endif		case inContent:#if 0			if (whichWindow != FrontWindow())				{				SelectWindow(whichWindow);				}			else {				if (ours(whichWindow))					DoContent(ds, ev);				}#endif			break;		}	}/* ---------------- DoCommand ------------------------------------------ */int hiliteMenu;int DoCommand( mResult )	long mResult;	{	int		theItem;		hiliteMenu = 1;	theItem = LoWord( mResult );	switch (HiWord(mResult))		{		case appleID:			DoApple(theItem);			break;		case fileID:			DoFile(theItem);			break;		case editID:			DoEdit(theItem);			break;		case compileID:			DoCompile(theItem);			break;					case controlID:			DoControl(theItem);			break;		}			if (hiliteMenu)		HiliteMenu(0);	return(1);	}	/* --------------- SetupCursors -------------------------------------- */SetupCursors()	{	CursHandle	hCurs;		hCurs = GetCursor(watchCursor);	waitCursor = **hCurs;		SetCursor(&arrow);	}	/* ---------------- MaintainCursor ------------------------------------ */MaintainCursor()	{	if (ours(FrontWindow()))		SetCursor(&arrow);	}	ours(w)	WindowPtr	w;	{	return (w == expwindow);	}	/* --------------- DoUpdate -------------------------------------------- */	DoUpdate(event)	EventRecord		*event;	{	if (ours((WindowPtr)event->message))		{		SetPort(expwindow);		EraseRect(&expwindow->portRect);		BeginUpdate(expwindow);		EndUpdate(expwindow);				if (me.started)			{			Msg(FinishMovie);			me.loaded = 0;			me.started = 0;			me.filePlaying = 0;			}		}	}	/* ---------------- DoActiveate ---------------------------------------- */DoActiveate(event)	EventRecord		*event;	{#if 0	Rect			r;		if (! ours((WindowPtr)event->message))		return;	r = ds->view->window->portRect;	r.top = r.bottom - (SBarWidth+1);	r.left = r.left - (SBarWidth+1);		/* ???? */	InvalRect(&r);	if (event->modifiers & activeFlag)		{		ShowControl(ds->view->scrollControl);		}	else {		HideControl(ds->view->scrollControl);		}#endif 	}	/* ------------- DoKeyDown --------------------------------------------- */	DoKeyDown(ev) 	EventRecord	*ev;	{	char	theChar;			theChar = ev->message & charCodeMask;	if ((ev->modifiers & cmdKey) != 0)		{		DoCommand(MenuKey(theChar));		}	else {		DoControl(ControlMenuKey(theChar));		}	}int ControlMenuKey(it)	int it;	{	switch (it)		{		case '3':			return (controlFastestM);		case '2':			return (controlFasterM);		case '1':			return (controlSlowerM);		}	}	DoEdit() {}/* --------------- SetupWindow ----------------------------------------- */	/* I'm not sure why this is necessary - it was in OVW DRV example */SetupVWWindow()	{	Rect	nscreenRect;		nscreenRect = screenBits.bounds;	expwindow = NewWindow(0L, &nscreenRect, "\pmywindow", TRUE, 4, -1L,	         FALSE, 0L);	        	SetPort(expwindow);		}	Expose()	{	SelectWindow(expwindow);	HideCursor();	}	UnExpose()	{#if 0	SendBehind(expwindow, -1L);	ShowCursor();#endif	}/* -------------- InitState ------------------------------------------- */InitState()	{	extern MenuHandle	controlMenu;	extern MenuHandle	compileMenu;		me.tempName = "\pUntitled.vwc";	me.tempVref = 0;		me.showConsole = 0; 		me.compiled = 0;		me.started = 0;	me.fileSelected = 0;	me.loaded = 0;	me.filePlaying = 0;		me.fileCompressing = 0;		me.pressSelected = 0;	me.saveDoubleBuffered = 0;	me.saveLooped = 1;			me.vtrigger = 1;	me.bigRead = 0;	me.allocMax = 1;		me.loop = 1;	me.tempoAdj = 0;	me.fastest = 0;			/* This much free space hanging around */	me.minfree = 5000;		me.source = 0;	me.self = 0;		CheckItem(compileMenu, compileAddLoop, me.saveLooped);	CheckItem(compileMenu, 				me.saveDoubleBuffered? compileDouble: compileSingle, 1);					CheckItem(controlMenu, controlLoopM, me.loop);	AllocateUnderMbar();			}	/* -------------- StepState -------------------------------------------- */StepState()	{		if (me.filePlaying)		{		if (! Msg(NextFrame))			{			Msg(FinishMovie);			me.loaded = 0;			me.filePlaying = 0;			me.started = 0;			RestoreScreen();			ShowCursor();			}		else if (Button())			{			DoControlStop();			}		}	}	/* ------------------------ CloseMovie --------------------------------- */	CloseMovie()	{	if (me.fileSelected && me.loaded)		{		Msg(FinishMovie);		me.filePlaying = 0;		me.loaded = 0;		me.started = 0;		}	}/* --------------------------------------------------------------------- */RestoreScreen()	{	RedrawStdout();	DrawMenuBar();	}	RedrawStdout()	{	WindowPtr	wp;	if (! me.showConsole)		return;			wp = FrontWindow();	if (wp)		{		SetPort(wp);		InvalRect(&wp->portRect);		}	}	SetupStdio()	{	static done = 0;	if (done) return;	done = 1;	Stdio_MacInit(TRUE);		Click_On(0);	/* Don't ask us to confirm on exit */	}	/* ---------------------------------------------------------------------- */