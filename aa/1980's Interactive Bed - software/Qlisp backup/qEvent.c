/*Process events.*/#include <WindowMgr.h>#include <MenuMgr.h>#include <EventMgr.h>#include <ToolboxUtil.h>#include <stdio.h>#include "qDef.h"#include "qMenu.h"#include "Obj.h"/* ------------------------------------------------------------------- */#define TRACE(a,b) printf bint		showConsole = 1;int		theKey = -1;#define	BS	0x08#define LF	0x0A#define CR	0x0Dtypedef struct	{	int			(**obj)();	WindowPtr	wp;	}	WindowObj;extern WindowObj	*me;extern WindowObj	*consoleWindow;extern WindowObj	*listenerWindow;extern qList		*windowList;/* -------------------------- AcceptEvent ---------------------------- */AcceptEvent()	{	EventRecord	evr;		NextEvent(&evr);	}	/* -------------- GetLine --------------------------------------------- */GetLine(str1)	Byte	*str1;	{	Byte	*str = str1;	EventRecord	evrec;		for (;;)		{		NextEvent(&evrec);		if (theKey < 0) continue;		putch(theKey);		if (theKey == BS)			{			/* Rubout processing */			if (str == str1)				continue;			str--;			putch(' ');			putch(BS);			}		if (theKey == CR)			{			/* Carrage return */			putch(LF);			*str = 0;			return;			}		*str++ = theKey;		}	}	/* ------------------------ NextEvent --------------------------------- */int NextEvent(ev)		EventRecord	*ev;	{	theKey = -1;		MaintainCursor();	SystemTask();		z(IDLE)();		if (GetNextEvent(everyEvent, ev) == FALSE)		return;			if (StdEvent(ev))		return;	switch (ev->what) 		{		case mouseDown:			DoMouseDown(ev);			break;		case keyDown:		case autoKey:			DoKeyDown(ev);			break;		case activateEvt:			DoActiveate(ev);			break;		case updateEvt:			DoUpdate(ev);			break;		}		return;	}/* ------------ DoMouseDown ------------------------------------------- */Rect			dragRect = { 0, 0, 10240, 10240 };DoMouseDown(ev)	EventRecord	*ev;	{	WindowPtr		whichWindow;	switch (FindWindow(ev->where, &whichWindow))		{		case inGoAway:			if (ours(whichWindow))				{				TrackGoAway(whichWindow, ev->where);				z(CLOSE)();				}			break;		case inMenuBar:			return( DoCommand( MenuSelect(ev->where) ));			break;		case inSysWindow:			SystemClick(ev, whichWindow);			break;		case inDrag:			if (ours(whichWindow))				{				DragWindow(whichWindow, ev->where, &dragRect);				z(DRAG)(ev);				}			break;		case inGrow:			if (ours(whichWindow))				z(GROW)(ev->where);			break;		case inContent:			if (whichWindow != FrontWindow())				{				SelectWindow(whichWindow);				}			else {				if (ours(whichWindow))					z(CONTENT)(ev);				}			break;		}	}/* ---------------- DoCommand ------------------------------------------ */int hiliteMenu;int DoCommand( mResult )	long mResult;	{	int		theItem;		hiliteMenu = 1;	theItem = LoWord( mResult );	switch (HiWord(mResult))		{		case appleID:			DoApple(theItem);			break;		case fileID:			DoFile(theItem);			break;		case editID:			DoEdit(theItem);			break;					case envID:			DoEnv(theItem);			break;		}			if (hiliteMenu)		HiliteMenu(0);	return(1);	}	/* --------------- SetupCursors -------------------------------------- */SetupCursors()	{#if 0	CursHandle	hCurs;		hCurs = GetCursor(watchCursor);	waitCursor = **hCurs;#endif	SetCursor(&arrow);	}	/* ---------------- MaintainCursor ------------------------------------ */MaintainCursor()	{	if (ours(FrontWindow()))		SetCursor(&arrow);	}	ours(w)	WindowPtr	w;	{	register qList		*lp = windowList;		for (; Listp(lp); lp = Cdr(lp))		{		if (w == ((WindowObj *) Car(lp))->wp )			{			me = (WindowObj *) Car(lp);			return (1);			}		}	return (0);	}	/* --------------- DoUpdate -------------------------------------------- */	DoUpdate(event)	EventRecord		*event;	{	if (! ours((WindowPtr)event->message))		return;		z(UPDATE)();	}	/* ---------------- DoActiveate ---------------------------------------- */DoActiveate(event)	EventRecord		*event;	{	if (! ours((WindowPtr)event->message))		return;			z(ACTIVATE)(event);		}	/* ------------- DoKeyDown --------------------------------------------- */#define EnterKey	0x03DoKeyDown(ev) 	EventRecord	*ev;	{	char	theChar;			theChar = ev->message & charCodeMask;	if ((ev->modifiers & cmdKey) != 0)		{		DoCommand(MenuKey(theChar));		}	else 		{		if (me->wp == FrontWindow() )			{			if (me == listenerWindow && theChar == EnterKey)				{				z(KEY_DOWN)( CR );				EvalText();				}			else				{				/* Send to text edit window */				z(KEY_DOWN)(theChar);				}			}		else			{			/* Pass on to reader */			theKey = theChar;			}		}	}/* ------------------------ DoFile ------------------------------------ */DoFile(it)	{	switch (it)		{		case fileNew:			z(NEW_FILE)();			break;		case fileOpen:			z(OPEN)();			break;		case fileClose:			z(CLOSE)();			break;		case fileSave:			z(SAVE)();			break;		case fileSaveAs:			z(SAVE_AS)();			break;		case fileRevert:			z(REVERT)();			break;		case fileQuit:			ExitToShell();			break;		}	}	/* ------------------------ DoEdit ------------------------------------ */DoEdit(it) 	{	switch (it)		{		case editCut:			z(CUT)();			break;		case editCopy:			z(COPY)();			break;		case editPaste:			z(PASTE)();			break;		case editClear:			z(CLEAR)();			break;		case editEval:			EvalText();			break;		}	}	/* -------------------- EvalText -------------------------------------- */EvalText()	{	qItem	it;		me = listenerWindow;		it = z(READ_STREAM)();	it = Eval( it );	me = consoleWindow;	z(PRINT_STREAM)(it);		me = listenerWindow;	}	/* --------------------- DoEnv ---------------------------------------- */DoEnv(it)	{	switch (it)		{		case envFuncs:			DoFuncDoc();			break;		}	}	/* --------------------- RedrawStdout --------------------------------- */RedrawStdout()	{	WindowPtr	wp;	if (! showConsole)		return;			wp = FrontWindow();	if (wp)		{		SetPort(wp);		InvalRect(&wp->portRect);		}	}/* ---------------------- SetupStdio ----------------------------------- */SetupStdio()	{	static done = 0;	if (done) return;	done = 1;	Stdio_MacInit(TRUE);		Click_On(0);	/* Don't ask us to confirm on exit */	}/* --------------------------------------------------------------------- */