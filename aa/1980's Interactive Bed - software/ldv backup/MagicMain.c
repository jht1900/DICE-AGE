/*Magic Digitizer DASeptember 18, 1987.John Thompson.*/#include <WindowMgr.h>#include <MenuMgr.h>#include <EventMgr.h>#include <DialogMgr.h>#include <ToolboxUtil.h>#include <DeviceMgr.h>#include "Magic.h"Cursor			waitCursor;Cursor			arrowCursor;MenuHandle		controlMenu;WindowPtr		myWin;Rect			vidRect;GrafPort		picPort;int				ncapture;int				onFrame;int				grabbing;int				reduceBy = 2;#define controlIDconstant	210int				controlID = controlIDconstant;int				DialogID = -16000;int				AlertId	= -16000;#if DA/* ---------- DA main ------------------------------------------------ */int already_open = 0;		/*  1 -> DA is already open  */DCtlPtr dce;				/*  device control entry  */main(p, d, n)	cntrlParam *p;	/*  ==> parameter block  */	DCtlPtr d;		/*  ==> device control entry  */	int n;			/*  entry point selector  */	{	/*  check to make sure our data area was allocated  */			if (d->dCtlStorage == 0)		{		if (n == 0) 			{	/*  open  */			SysBeep(3);			CloseDriver(d->dCtlRefNum);			}		return(0);		}		dce = d;	switch (n) 		{		GrafPtr	oldPort;				case 0:		/*  open  */			doOpen();			break;		case 2:		/*  control  */			GetPort(&oldPort);			SetPort(myWin);			switch (p->csCode) 				{				case accEvent:					DoEvent(* ((EventRecord *)&p->csParam));					break;				case accMenu:					DoControl(p->csParam[1]);					HiliteMenu(0);					break;				case accCopy:					MagEditCopy();					break;				case accRun:					StepState();					break;				case goodBye:					break;				}			SetPort(oldPort);			break;		case 4:		/*  close  */			doClose();			break;		}		/*  done  */		return(0);	}doOpen()	{	/*  every time ...  */#if 1	dce->dCtlFlags |= dNeedLock | dNeedTime;#endif#if 1	dce->dCtlMenu = dce->dCtlRefNum;#endif	if (already_open)		return;			/*  first time only ...  */			already_open = 1;	controlID = dce->dCtlMenu;	DialogID = rsrcID(0);	AlertId = rsrcID(0);		Setup();		SetupControlMenu();	DrawMenuBar();		((WindowPeek)myWin)->windowKind = dce->dCtlRefNum;	dce->dCtlWindow = myWin;		}	rsrcID(id)	{	return(0xC000 + (~dce->dCtlRefNum << 5) + id);	}doClose()	{	DeleteMenu(dce->dCtlMenu);	DrawMenuBar();	DisposeMenu(controlMenu);		DisposeWindow(myWin);	dce->dCtlWindow = (WindowPtr)0;		dce->dCtlMenu = 0;		MagFree();		MagicBoxFree();		already_open = 0;	}	DoMouseDown(ev)	EventRecord	*ev;	{	MagicContent(ev);	}DoKeyDown(ev)	EventRecord	*ev;	{	char	theChar;			theChar = ev->message & charCodeMask;	if ((ev->modifiers & cmdKey) != 0		&& theChar == 'c')		{		MagEditCopy();		}	}#else/* ----------------- Application main --------------------------------- */MenuHandle		myMenus[NMENU];main()	{	Initialize();	Setup();	fatal("\pHello.","\pJohn");	for (;;) 		{		MainEvent();		StepState();		}	}/* ------------ Initialize -------------------------------------------- */	Initialize()	{#if 1	Stdio_MacInit(TRUE);		Click_On(0);	/* Don't ask us to confirm on exit */#endif	InitGraf(&thePort);	InitFonts();	FlushEvents(everyEvent, 0);	InitWindows();	InitMenus();	TEInit();	InitDialogs(0L);	MaxApplZone();	SetupMenus();	}/* -------------- MainEvent -------------------------------------------- */int MainEvent()	{	EventRecord	myEvent;	MaintainCursor();	SystemTask();	if (GetNextEvent(everyEvent, &myEvent) == FALSE)		return;#if 0	StdEvent(&myEvent);#endif	DoEvent(&myEvent);	}/* ------------ DoMouseDown ------------------------------------------- */Rect			dragRect = { 0, 0, 1024, 1024 };DoMouseDown(ev)	EventRecord	*ev;	{	WindowPtr		whichWindow;	switch (FindWindow(ev->where, &whichWindow))		{		case inGoAway:			if (myWin == whichWindow)				{				TrackGoAway(myWin, ev->where);				}			break;		case inMenuBar:			return( DoCommand( MenuSelect(ev->where) ));			break;		case inSysWindow:			SystemClick(ev, whichWindow);			break;		case inDrag:			if (myWin == whichWindow)				{				DragWindow(whichWindow, ev->where, &dragRect);				}			break;		case inGrow:			break;		case inContent:			if (whichWindow == myWin)				MagicContent(ev);			break;		}	}	/* ---------------- DoCommand ------------------------------------------ */int DoCommand( mResult )	long mResult;	{	int		theItem;	Str255	name;		theItem = LoWord( mResult );	switch (HiWord(mResult))		{		case appleID:			GetItem(myMenus[0], theItem, &name);			OpenDeskAcc( &name );			break;		case fileID:			DoFile(theItem);			break;					case editID:			DoEdit(theItem);			break;		case controlIDconstant:			DoControl(theItem);			break;		}			HiliteMenu(0);	return(1);	}/* ------------------- DoEdit ---------------------------------------- */#define editUndo	1#define editCut		3#define editCopy	4#define editPaste	5#define editClear	6DoEdit(it)	{	if (SystemEdit(it-1))		return;	switch (it)		{		case editUndo:			break;		case editCut:			break;		case editCopy:			MagEditCopy();			break;		case editPaste:			break;		case editClear:			break;		}	}	/* ------------------- DoFile ------------------------------------------ */DoFile(it) 	{	ExitToShell();	}	/* ------------- DoKeyDown --------------------------------------------- */	DoKeyDown(ev) 	EventRecord	*ev;	{	char	theChar;			theChar = ev->message & charCodeMask;	if ((ev->modifiers & cmdKey) != 0)		{		DoCommand(MenuKey(theChar));		}	}/* -------------- SetupMenus ----------------------------------------- */SetupMenus()	{	int		i;	MenuHandle	m;		m = myMenus[appleM] = NewMenu(appleID, "\p\024" );	AppendMenu(m, "\pAbout V.W.Presser ;(-");	AddResMenu(m, 'DRVR');	m = myMenus[fileM] = NewMenu(fileID, "\pFile");	AppendMenu(m, "\pQuit ");		m = myMenus[editM] = NewMenu(editID, "\pEdit");	AppendMenu(m, "\pUndo /Z;(- ;Cut /X;Copy /C;Paste /V;Clear ");	for (i = 0; i < NMENU; i++ ) 		InsertMenu(myMenus[i], 0) ;	SetupControlMenu();		DrawMenuBar();	}/* ---------------- MaintainCursor ------------------------------------ */MaintainCursor()	{	if (FrontWindow() == myWin)		SetCursor(&arrowCursor);	}	/*---- End Application DA ----*/#endif/* ----------------------------- DoEvent ---------------------------- */DoEvent(ev)	EventRecord	*ev;	{	switch (ev->what) 		{		case mouseDown:			DoMouseDown(ev);			break;		case keyDown:		case autoKey:			DoKeyDown(ev);			break;		case activateEvt:			DoActiveate(ev);			break;		case updateEvt:			DoUpdate(ev);			break;		}		}	/* ------------------- DoControl -------------------------------------- */static int		grabChecked = ctlGrab1;static int		sizeChecked = ctlHalf;DoControl(it)	{	switch (it)		{		case ctlGrab1:			MagAlloc(ncapture = 1);			CheckCtl(ctlGrab1);			break;		case ctlGrabMid:			MagAlloc(ncapture = 4);			CheckCtl(ctlGrabMid);			break;		case ctlGrabHi:			MagAlloc(ncapture = 8);			CheckCtl(ctlGrabHi);			break;#if 0		case ctlFirst:			onFrame = 0;			MagShowOne();			break;		case ctlPrev:			onFrame -= 1;			if (onFrame < 0) onFrame = ncapture -1;			MagShowOne();			break;		case ctlNext:			NextFrame();			break;		case ctlLast:			onFrame = ncapture -1;			MagShowOne();			break;#endif		case ctlFull:			reduceBy = 1;			CheckSize(ctlFull);			break;		case ctlHalf:			reduceBy = 2;			CheckSize(ctlHalf);			break;		case ctlQuarter:			reduceBy = 4;			CheckSize(ctlQuarter);			break;		}	}	NextFrame()	{	onFrame += 1;	if (onFrame >= ncapture) onFrame = 0;	MagShowOne();	}CheckSize(it)	{	if (sizeChecked > -1)		CheckItem(controlMenu, sizeChecked, FALSE);	sizeChecked = it;	CheckItem(controlMenu, sizeChecked, TRUE);	}	CheckCtl(it)	{	if (grabChecked > -1)		CheckItem(controlMenu, grabChecked, FALSE);	grabChecked = it;	CheckItem(controlMenu, grabChecked, TRUE);	}	/* --------------- MagEditCopy ------------------------------------------ */#include <ScrapMgr.h>#include <MemoryMgr.h>MagEditCopy()	{	PicHandle	ph;	Rect		rt;		SetCursor(&waitCursor);		MagSize(&rt);	if (reduceBy)		{		rt.bottom = rt.bottom / reduceBy;		rt.right = rt.right / reduceBy;		}		SetPort(&picPort);		ClipRect(&rt);		ZeroScrap();	ph = OpenPicture(&rt);		MagToWin(&picPort, &rt, onFrame);		ClosePicture();		HLock(ph);	PutScrap(GetHandleSize(ph), 'PICT', *ph);#if 0	printf("Picture size =%ld\n", GetHandleSize(ph));#endif	DisposHandle(ph);		SetCursor(&arrowCursor);	}	/* --------------- SetupCursors -------------------------------------- */SetupCursors()	{	CursHandle	hCurs;		hCurs = GetCursor(watchCursor);	waitCursor = **hCurs;		hCurs = GetCursor(crossCursor);	arrowCursor = **hCurs;		SetCursor(&arrowCursor);	}	/* --------------- DoUpdate -------------------------------------------- */	DoUpdate(event)	EventRecord		*event;	{	if (myWin != (WindowPtr)event->message)		return;	BeginUpdate(myWin);		DrawControls(myWin);		UpdateBox();		MagShowOne();	EndUpdate(myWin);	}	/* ---------------- DoActiveate ---------------------------------------- */DoActiveate(ev)	EventRecord		*ev;	{	}	/* -------------- StepState -------------------------------------------- */StepState()	{	if (grabbing)		{		MagShow();		}	}/* ---------------- MagShow ------------------------------------------- */MagShow()	{	MagCapture();	MagShowAll(myWin, &vidRect);	onFrame = ncapture-1;	FrameNum(onFrame);	}/* ----------------- MagShowOne -------------------------------------- */MagShowOne()	{	FrameNum(onFrame);	MagToWin(myWin, &vidRect, onFrame);	}	/* ----------------- MagTakeOne --------------------------------------- */MagTakeOne()	{	MagCaptureOne(onFrame);	MagToWin(myWin, &vidRect, onFrame);	}	/* ------------ fatal ------------------------------------------------ */fatal(m1, m2)	Byte	*m1;	Byte	*m2;	{	ParamText(m1, m2, "\p", "\p");	StopAlert(AlertId, 0L);	}	/* --------------------- Setup ---------------------------------------- */Setup()	{	SetupCursors();	MagPortB();	MagInit();	if (MagAlloc(ncapture = 1))		return (1);	onFrame = 0;	grabbing = 0;		OpenPort(&picPort);		if (MakeMagicBox())		return (1);			SetupMagicBox();		return (0);	}	/* --------------------- ControlMenu ----------------------------------- */SetupControlMenu()	{	controlMenu = NewMenu(controlID, "\pMvideo");		AppendMenu(controlMenu, "\pTake 1 ;Take 4 ;Take 8 ;(- \;Full size ;Reduce to half ;Reduce to quarter");	InsertMenu(controlMenu, 0);		CheckItem(controlMenu, ctlGrab1, TRUE);	CheckItem(controlMenu, ctlHalf, TRUE);	}	/* -------------------------------------------------------------------- */