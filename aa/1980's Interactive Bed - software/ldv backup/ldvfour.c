/*Operations for pioneer LD-V4200 player.*/#include <SerialDvr.h>#include "qDef.h"#include "vdisc.h"static int chan = AoutRefNum;#define PPort sPortA/* ---------------------- Vd1 ----------------------------------------- */static Vd1(op)	int	op;	{	Vd1n(op);	vdgetack();	}	static Vd1n(op)	int	op;	{	int		er;	long	count;	Byte	buf[16];		buf[0] = op >> 8;	buf[1] = op;	buf[2] = 0x0D;	count = 3;	er = FSWrite(chan, &count, buf);	if (er) OhShit("\pvd1 write");	}	/* ----------------------- Vd -------------------------------------------*/static Vd(op, n)	{	Vdn(op, n);	vdgetack();	}	static Vdn(op, n)	int			op;	unsigned	n;	{	Byte	buf[32];	long	count;	int		er;	count = stcu_d(buf, n, 16);	buf[count] = op >> 8;	buf[count+1] = op;	buf[count+2] = 0x0D;	count += 3;	er = FSWrite(chan, &count, buf);	if (er) OhShit("\pvd write");	}	/* ----------------------------- vdflush -------------------------------*/static vdflush()	{	long	count;	Byte	buf[128];	SerGetBuf(chan + 1, &count);		if (count < 1) return (0);	if (count > 128) count = 128;	FSRead(chan + 1, &count, buf);		return ( (int) count );	}/* ---------------------- vdgetack -------------------------------------- */static vdgetack()	{	long	count;	Byte	buf[32];	int		i;	long	timeOut = TickCount() + 4*60;	extern int	vidport;		while (TickCount() < timeOut)		{		if (Button()) return;		SerGetBuf(chan + 1, &count);			if (count >= 2)			{			FSRead(chan + 1, &count, buf);			return;			}		}	doalert("\pVideo disc player not responding",		"\pPlease check serial cable and power",		(vidport == 2)?"\pfor disc #2": "\pfor disc #3",		"\p");	}/* -------------------- vdreadpos -------------------------------------- */#define NOVAL (-1)static vdreadpos()	{	int	it;		vdflush();		Vd1n('?F');		while ((it = vdread()) == NOVAL && ! Button()) ;		return (it);	}/* ------------------ vdread ------------------------------------------- */static vdread()	{	long count;	Byte buf[32];	int	er, n;		SerGetBuf(chan + 1, &count);	if (count >= 6)		{		er = FSRead(chan + 1, &count, buf);		if (er) OhShit("\pFSRead er=%d on count=%d\n", er, count);		buf[count] = 0;#if 0		printf(" buf=%s\n",buf);#endif		stcd_i(buf, &n);		return ( n );		}			return (NOVAL);	}/* -------------------------- vdwait ------------------------------------ */static vdwait(target)	int	target;	{	int	vl;		vdflush();		for (; !Button();)		{		Vd1n('?F');		for (; !Button();)			{			vl = vdread();			if (vl == NOVAL)				continue;			if (vl != target)				break;			return (NOVAL);			}		}	}	/* ------------------------- init ------------------------------------ */static init()	{	int serConfig = baud4800 + stop10 + noParity + data8;	int er;		er = RAMSDOpen(PPort);	if (er) OhShit("Er=%d on RAMSopen\n", er);	er = SerReset(chan, serConfig);	if (er) OhShit("er=%d on serreset of output\n", er);	er = SerReset(chan + 1, serConfig);	if (er) OhShit("er=%d on serreset of input\n", er);	}	static play()	{	Vd1('PL');	}	static stop()	{	Vd1('ST');	}	static search(a)	{	Vdn('SE', a);	}	static searchwait()	{	vdgetack();	}	static pos()	{	return (vdreadpos());	}	static stepfwd()	{	Vd1('SF');	}	static steprev()	{	Vd1('SR');	}	static ff(n)	{	if (n < 1) n = 1;	Vd('SP', 60*n);	Vd1('MF');	}	static rew(n)	{	if (n < 1) n = 1;	Vd('SP', 60*n);	Vd1('MR');	}	static slowfwd(n)	{	if (n < 1) n = 60;	Vd('SP', 60/n);	Vd1('MF');	}	static slowrev(n)	{	if (n < 1) n = 60;	Vd('SP', 60/n);	Vd1('MR');	}	static video(n)	{	Vd('VD', n);	}	static audio(n)	{	Vd('AD', n);	}	static frame(n)	{	Vd('RA', n? 5: 4);	}	static chargen(n)	{	Vd('DS', n);	}	static setmark(n)	{	Vd('SM', n);	}	static stopat(n)	{	Vd('SM', n );	Vd1('PL');	}	static audiosq(n)	{	Vd('RB', n? 0: 64);	}		static text(linen, coln, str)	int		linen;	int		coln;	Byte	*str;	{	Byte	buf[32];	long	i;		for (i = 0; i < coln; i++) buf[i] = ' ';	for (; *str; str++, i++) buf[i] = *str;	buf[i] = 0x0D;	i += 1;		Vd('PR', linen);		FSWrite(chan, &i, buf);	vdgetack();		}	static cleartext()	{	Vd1('CS');	}static int (*msgTable[])() =	{	init,	play, stop, search, searchwait, pos,	stepfwd, steprev, ff, rew, slowfwd, slowrev,	video, audio,	frame, chargen,	setmark, stopat,	audiosq, text, cleartext	};Object ldvfourObj = msgTable;/* --------------------------------------------------------------------- */