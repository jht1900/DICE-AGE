/**/#include <WindowMgr.h>#include <EventMgr.h>#include <ControlMgr.h>#include <ResourceMgr.h>#include <DialogMgr.h>#include "DialogRes.h"#include "Magic.h"#define	TRACE 0extern WindowPtr	myWin;extern int			DialogID;DitlTPtr			*itemList;int					nitems;static Handle		ditlRes;static int			failed;/* ---------------------- MakeMagicBox -------------------------------- */MakeMagicBox()	{	Handle		hd;	int			type;	DialogTPtr	dp;	DitlTPtr	ip;	ControlTPtr	cp;	int			i;		failed = 0;	hd = GetResource('DLOG', DialogID);	if (! hd) 		{		fatal("\pGet dlog failed","\p");		return (1);		}			HLock(hd);	dp = (DialogTPtr)(*hd);		myWin = NewWindow(0L, &dp->boundsRect, dp->title, TRUE/*-visible-*/,				dp->procID, -1L/*-behind-*/, TRUE/*-goaway-*/,				dp->refCon);	if (! myWin) 		{		fatal("\pNew window failed","\p");		return (1);		}			ReleaseResource(hd);		ditlRes = GetResource('DITL', dp->itemsID);	if (! ditlRes) 		{		fatal("\pGet DITL failed","\p");		return (1);		}			HLock(ditlRes);		nitems = * (int *)(*hd);	nitems += 1;#if TRACE	printf("*hd=%lx nitems=%d itemsID=%d\n",*hd,nitems,dp->itemsID);	SelectWindow(myWin);#endif	itemList = ip = (DitlTPtr) ( ((int *)(*hd)) + 1);	for (i = 0; i < nitems; i++)		{		MakeDialogItem(ip, i+1);		if (ip->len & 1)			{			fatal("\pOdd length item in ditl","\p");			return (1);			}		ip = (DitlTPtr)((Byte *)ip + sizeof(DitlTemplate) + ip->len);		}			return (failed);	}	MagicBoxFree()	{	ReleaseResource(ditlRes);	}	/* -------------------- MakeDialogItem -------------------------------- */MakeDialogItem(ip, item)	DitlTPtr	ip;	int			item;	{#if TRACE	printf("ip=%lx type=%d len=%d\n",ip, ip->type,ip->len);	SelectWindow(myWin);#endif	switch (ip->type)		{		case ctrlItem + btnCtrl:			MakeControl(ip, pushButProc, item);			break;		case ctrlItem + chkCtrl:			MakeControl(ip, checkBoxProc, item);			break;		case ctrlItem + radCtrl:			MakeControl(ip, radioButProc, item);			break;		case ctrlItem + resCtrl:			MakeResControl(ip, item);			break;		case statText:			MakeStatText(ip);			break;		case editText:			MakeEditText(ip, item);			break;		}	}	/* -------------------------------------------------------------------- */MakeControl(ip, ctype, item)	DitlTPtr	ip;	int			ctype;	int			item;	{#if TRACE	printf("make control ctype=%d\n",ctype);	SelectWindow(myWin);#endif	ip->cp = NewControl(myWin, &ip->bounds, &ip->len, TRUE/*-visible-*/,				0/*-value-*/, 0/*-min-*/, 1/*-max-*/, 				ctype, (long)item/*-refCon-*/);	}	MakeStatText(ip)	DitlTPtr	ip;	{	FontInfo	fi;#if TRACE	printf(" stat text %d %.8s\n", ip->len, ip->info);	SelectWindow(myWin);#endif	SetPort(myWin);	TextFont(0);	GetFontInfo(&fi);	EraseRect(&ip->bounds);	MoveTo( ip->bounds.left, ip->bounds.top + fi.ascent);	DrawString(&ip->len);	}	MakeEditText(ip)	DitlTPtr	ip;	{	}	MakeResControl(ip, item)	DitlTPtr	ip;	int			item;	{	Handle		hd;	ControlTPtr	cp;#if TRACE	printf("res control id=%d", *(int *)&ip->info);	SelectWindow(myWin);#endif	hd = GetResource('CNTL', *(int *)&ip->info);	if (! hd) 		{		fatal("\pGet res of cntl item","\p");		failed = 1;		}			HLock(hd);		cp = (ControlTPtr) (*hd);		ip->cp = NewControl(myWin, &ip->bounds, &ip->len, TRUE/*-visible-*/,				cp->val/*-value-*/, cp->min/*-min-*/, cp->max/*-max-*/, 				cp->procID, (long)item/*-refCon-*/);					ReleaseResource(hd);	}/* --------------------------------------------------------------------- */UpdateBox()	{	int			i;	DitlTPtr	ip;	ip = itemList;	for (i = 0; i < nitems; i++)		{		if (ip->type == statText)			MakeStatText(ip);		ip = (DitlTPtr)((Byte *)ip + sizeof(DitlTemplate) + ip->len);		}	}/* --------------------------------------------------------------------- */DitlTPtr FindDitl(item)	int		item;	{	DitlTPtr	ip;	int			i;	ip = itemList;	for (i = 1; i < item; i++)		{		ip = (DitlTPtr)((Byte *)ip + sizeof(DitlTemplate) + ip->len);		}	return (ip);	}	/* --------------------------------------------------------------------- */GetDitlRect(item, rt)	int		item;	Rect	*rt;	{	DitlTPtr	ip;	ip = FindDitl(item);	*rt = ip->bounds;	}		/* --------------------------------------------------------------------- */ControlHandle GetDitlControl(item)	int		item;	{	return ((FindDitl(item))->cp);	}/* --------------------------------------------------------------------- */	